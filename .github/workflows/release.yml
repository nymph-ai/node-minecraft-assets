name: Minecraft Assets release
on:
  repository_dispatch:
    types: [mcassets-tag]
jobs:
  update-mcassets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment: npm-publish
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.0.0
          registry-url: https://registry.npmjs.org
      - name: Configure git
        run: |
          git config user.name 'nymph-ai-bot'
          git config user.email 'nymph-ai-bot@users.noreply.github.com'
      - name: Update minecraft assets
        run: |
          cd minecraft-assets/
          git fetch --all --tags
          git checkout ${{ github.event.client_payload.tag }}
      - name: Bump version
        run: |
          git add minecraft-assets
          bash scripts/bump-nymph-version.sh "${{ github.event.client_payload.tag }}"
      - name: Push changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes to push."
            exit 0
          fi
          git push
      - name: Publish
        if: ${{ success() }}
        run: |
          rm -f .npmrc
          npm config delete //registry.npmjs.org/:_authToken || true
          npm publish --provenance --access public
